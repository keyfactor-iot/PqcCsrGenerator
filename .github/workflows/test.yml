name: Test PQC CSR Generator

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-all-algorithms:
    name: Test All Algorithms
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compile project
        run: mvn compile -B

      - name: Generate all CSRs
        run: |
          mkdir -p ./output
          mvn exec:java -Dexec.args="--all" -Dcsr.outdir="./output" -B

      - name: Verify output files exist
        run: |
          CSR_COUNT=$(ls ./output/*.csr 2>/dev/null | wc -l)
          echo "CSR files generated: $CSR_COUNT"
          if [ "$CSR_COUNT" -lt 23 ]; then
            echo "ERROR: Expected at least 23 CSR files, got $CSR_COUNT"
            exit 1
          fi

  test-individual-algorithms:
    name: Test Individual - ${{ matrix.algorithm }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        algorithm:
          - ML-DSA-44
          - ML-DSA-65
          - ML-DSA-87
          - SLH-DSA-SHA2-128f
          - Ed25519
          - EC-P256
          - RSA-2048

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Generate ${{ matrix.algorithm }} CSR
        run: |
          mkdir -p ./output
          mvn compile exec:java \
            -Dexec.args="${{ matrix.algorithm }}" \
            -Dcsr.subject="CN=${{ matrix.algorithm }} Test,O=GitHub Actions,C=US" \
            -Dcsr.outdir="./output" \
            -B

      - name: Verify files created
        run: |
          ALG_LOWER=$(echo "${{ matrix.algorithm }}" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
          ls -la ./output/${ALG_LOWER}.csr

  test-extensions-and-subject:
    name: Test Subject DN & SAN Tagging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Generate Complex CSR
        run: |
          mkdir -p ./output
          mvn compile exec:java \
            -Dexec.args="ML-DSA-65" \
            -Dcsr.subject="CN=PQC-Action-Server,O=Keyfactor,C=US" \
            -Dcsr.san="pqc.local,192.168.1.100,https://keyfactor.com,dev@keyfactor.com" \
            -Dcsr.outdir="./output" \
            -B

      - name: Verify Subject DN and SAN Tags
        run: |
          CSR_TEXT=$(openssl req -in ./output/ml_dsa_65.csr -noout -text)
          echo "--- Full CSR Text ---"
          echo "$CSR_TEXT"
          echo "---------------------"

          # Verify Subject DN
          echo "Verifying Subject..."
          echo "$CSR_TEXT" | grep -q "Subject: CN = PQC-Action-Server, O = Keyfactor, C = US" || (echo "FAILED: Subject DN mismatch" && exit 1)
          
          echo "Verifying SAN Tags..."
          # Verify DNS tag (Tag 2)
          echo "$CSR_TEXT" | grep -q "DNS:pqc.local" || (echo "FAILED: DNS tag missing" && exit 1)
          
          # Verify IP Address tag (Tag 7)
          echo "$CSR_TEXT" | grep -q "IP Address:192.168.1.100" || (echo "FAILED: IP Address tag missing" && exit 1)
          
          # Verify URI tag (Tag 6)
          echo "$CSR_TEXT" | grep -q "URI:https://keyfactor.com" || (echo "FAILED: URI tag missing" && exit 1)
          
          # Verify Email tag (Tag 1)
          echo "$CSR_TEXT" | grep -q "email:dev@keyfactor.com" || (echo "FAILED: Email tag missing" && exit 1)
          
          echo "✓ Subject and all SAN extensions verified successfully."

  test-build-path-logic:
    name: Test Build Paths
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Verify path WITHOUT extensions (buildCsr)
        run: |
          mkdir -p ./output/no-san
          mvn compile exec:java -Dexec.args="ML-DSA-44" -Dcsr.outdir="./output/no-san" -B
          # Verify the extension section does not exist
          openssl req -in ./output/no-san/ml_dsa_44.csr -noout -text | grep -qv "Subject Alternative Name"
          echo "✓ Verified simple buildCsr path."

  test-error-handling:
    name: Test Error Handling
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Test invalid algorithm
        run: |
          mvn compile exec:java -Dexec.args="INVALID-ALGO" -B 2>&1 || EXIT_CODE=$?
          if [ "$EXIT_CODE" -eq 1 ]; then
            echo "✓ Correctly rejected invalid algorithm"
          else
            echo "ERROR: Expected exit code 1, got $EXIT_CODE"
            exit 1
          fi